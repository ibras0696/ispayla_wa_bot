# Green API WhatsApp Bot

В проекте используется официальный пакет `whatsapp-chatbot-python`, который через долгий опрос (long polling) получает события из Green API. Никаких вебхуков и отдельного FastAPI-приложения не требуется.

## Установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -e .
cp .env.example .env  # заполните ID_INSTANCE и API_TOKEN, а также параметры Postgres
```

Или просто выполните `make install`, чтобы автоматизировать шаги выше.

Чтобы ограничить тестирование одним чатом, пропишите в `.env` строку `ALLOWED_SENDERS=79323056361` (или c доменом `79323056361@c.us`). Бот будет отвечать только указанным отправителям.

## Запуск бота (аналогично aiogram)

В директории `app/bot` теперь структура ближе к сервису:
- `handlers/` — обработчики (`basic.py` со стартовыми командами и `menu.py` с меню).
- `services/` — вспомогательные сервисы (`state.py` для фонового event loop, `guard.py` для whitelists и утилит отправителя).
- `runner.py` — создаёт `GreenAPIBot`, навешивает обработчики, инициализирует фоновые задачи и БД.

Файл `app/bot_runner.py` — минимальная точка входа, которая зовёт `create_bot()` и запускает `.run_forever()`.

Запуск:

```bash
make bot
# или напрямую
python -m app.bot_runner
```

Что происходит:
- библиотека сама настраивает нужные уведомления в кабинете Green API;
- бот получает входящие события через `receiveNotification`, так что вебхук и публичный домен не нужны;
- все новые отправители попадают в таблицу `users`, команда `баланс` вытаскивает данные из базы.
- команда `0`/`00`/`000` показывает reply-кнопки «Профиль», «Продажа», «Покупка».

### Доступные команды
- `/start` — приветственное сообщение и подсказка, что можно ввести `баланс`.
- `баланс` — выводит баланс пользователя из таблицы `users`.
- `0`, `00` или `000` — открывает меню с интерактивными reply-кнопками («Профиль», «Продажа», «Покупка»). Кнопки реализованы через `sendInteractiveButtonsReply`.
- Текстовые команды `профиль`/`profile`, `продажа`/`sell`, `покупка`/`buy` работают так же, как нажатие соответствующих кнопок (удобно для тестов без UI).
- В меню «Продажа» доступны подпункты:
  - «Разместить объявление» запускает пошаговый мастер (заголовок, описание, цена, марка, год, пробег, VIN, фото). На каждом шаге можно отправить `отмена`.
    Фото нужно присылать как вложение (бот сохранит их в `media/uploads`), по завершении пишем `готово` и объявление сразу попадает в БД.
  - «Мои объявления» показывает статистику по объявлениям в БД (кол-во, активные, несколько последних записей).

Дальше можно дописывать фильтры и обработчики (см. `examples` в репозитории Green API).

В `docs/greenapi_samples/` лежат примеры реальных уведомлений (`incomingMessageReceived`, `outgoingMessageReceived`), чтобы быстро ориентироваться в структуре JSON.

## Полезные команды Makefile

- `make lint` — прогнать Ruff.
- `make test` — запустить pytest.
- `make up` / `make down` — поднять или остановить Docker-стек.
- `make bot-shell` — открыть shell внутри контейнера приложения.
- `make db-shell` — открыть shell внутри контейнера Postgres.

## Docker/Compose

Для развёртывания без локального Python используйте Docker:

```bash
docker compose up --build
```

Файл `docker-compose.yml` поднимет Postgres 16 и сервис `bot`, который запускает `app.bot_runner`. Настройки тянутся из `.env`, поэтому убедитесь, что там указаны креды БД и ключи Green API. При необходимости добавьте сервис `migrate` с `alembic upgrade head`.

## Дальнейшие шаги
- расширить обработчики, используя модули `database.crude`;
- добавить работу с медиа, кнопками, сценами (`router.state`) из `whatsapp-chatbot-python`;
- при необходимости дописать миграционный контейнер, CI, мониторинг и т.д.
